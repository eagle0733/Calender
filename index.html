<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Drag-n-Drop 行事曆（含 日/週/月 檢視）</title>
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#111827">
<style>
  :root{ --bg:#f6f7f9; --panel:#ffffff; --text:#111827; --muted:#6b7280; --line:#e5e7eb; --accent:#111827; }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Noto Sans,Helvetica,Arial,'Apple Color Emoji','Segoe UI Emoji';background:var(--bg);color:var(--text)}
  .wrap{max-width:1200px;margin:0 auto;padding:12px 16px 64px}
  .toolbar{position:sticky;top:0;background:rgba(255,255,255,.92);backdrop-filter:saturate(180%) blur(8px);border-bottom:1px solid var(--line);z-index:20}
  .toolbar .row{display:flex;gap:8px;align-items:center;max-width:1200px;margin:0 auto;padding:10px 16px;flex-wrap:wrap}
  button,select,input[type="file"]{font:inherit}
  button{padding:6px 10px;border:1px solid #d1d5db;border-radius:10px;background:#fff;cursor:pointer}
  button:hover{background:#f9fafb}
  select,input[type="color"],input[type="text"],input[type="number"]{padding:6px;border:1px solid #d1d5db;border-radius:8px;background:#fff}
  .panels{display:grid;grid-template-columns:280px 1fr;gap:12px;margin-top:12px}
  @media (max-width: 900px){ .panels{grid-template-columns:1fr} }
  .panel{background:var(--panel);border:1px solid var(--line);border-radius:16px}
  .panel .head{padding:12px 12px;border-bottom:1px solid var(--line);font-weight:600;display:flex;align-items:center;gap:8px}
  .panel .body{padding:12px}
  .muted{color:var(--muted);font-size:12px}
  .tabs{display:inline-flex;border:1px solid var(--line);border-radius:999px;overflow:hidden}
  .tabs button{border:0;padding:6px 12px;background:#fff}
  .tabs button.active{background:#111827;color:#fff}
  /* Calendar - shared */
  .cal{overflow:hidden;border-radius:16px}
  .legend{display:flex;flex-wrap:wrap;gap:8px;margin:8px 0}
  .pill{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--line);border-radius:999px;padding:4px 8px}
  .dot{width:10px;height:10px;border-radius:50%}
  .timecol{background:#fafafa;border-right:1px solid var(--line)}
  .timecell{height:48px;border-bottom:1px solid var(--line);display:flex;align-items:flex-start;justify-content:flex-end;padding:3px 8px;color:#6b7280;font-size:12px}
  .minor{position:absolute;left:0;right:0;border-bottom:1px dashed #eee}
  .event{position:absolute;left:4px;right:4px;border:1px solid #cbd5e1;background:#e5e7eb33;border-radius:12px;box-shadow:0 1px 0 rgba(0,0,0,.04);overflow:hidden}
  .event.sel{outline:2px solid rgba(0,0,0,.2)}
  .event .pad{padding:6px}
  .event .title{width:100%;border:0;background:transparent;font-weight:600}
  .event .meta{font-size:12px;color:#4b5563;margin-top:2px}
  .event .bar{font-size:12px;display:flex;gap:6px;align-items:center;margin-top:6px}
  .handle{position:absolute;left:0;right:0;height:8px;cursor:ns-resize}
  .handle.top{top:0}
  .handle.bot{bottom:0}
  .foot-fab{position:fixed;left:0;right:0;bottom:10px;display:flex;justify-content:center;pointer-events:none;z-index:30}
  .fab{pointer-events:auto;background:#fff;border:1px solid var(--line);border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,.08);padding:6px 8px;display:flex;gap:8px;align-items:center}
  .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:72px;background:#111827;color:#fff;padding:10px 14px;border-radius:10px;font-size:12px;display:none;z-index:60}
  .toast.show{display:block}
  /* Week */
  .cal-head{display:grid;grid-template-columns:80px repeat(7,1fr);border-bottom:1px solid var(--line)}
  .cal-head > div{padding:10px 6px;text-align:center;font-weight:600}
  .cal-body{position:relative;height:1152px}
  .cal-grid{position:absolute;inset:0;display:grid;grid-template-columns:80px repeat(7,1fr)}
  .daycol{position:relative;border-right:1px solid var(--line);touch-action:none}
  /* Day */
  .day-head{display:grid;grid-template-columns:80px 1fr;border-bottom:1px solid var(--line)}
  .day-body{position:relative;height:1152px}
  .day-grid{position:absolute;inset:0;display:grid;grid-template-columns:80px 1fr}
  .daycol-single{position:relative;border-right:0;touch-action:none}
  /* Month */
  .month-head{display:grid;grid-template-columns:repeat(7,1fr);border-bottom:1px solid var(--line)}
  .month-head > div{padding:10px 6px;text-align:center;font-weight:600}
  .month-grid{display:grid;grid-template-columns:repeat(7,1fr);grid-auto-rows:120px}
  .mcell{border-right:1px solid var(--line);border-bottom:1px solid var(--line);padding:6px;position:relative}
  .mdate{font-size:12px;color:#6b7280}
  .mtag{display:block;font-size:11px;margin-top:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;border-left:3px solid currentColor;padding-left:6px}
</style>
</head>
<body>
  <div class="toolbar">
    <div class="row">
      <strong>Drag-n-Drop 行事曆</strong>
      <span class="muted" id="tz"></span>
      <div class="tabs" role="tablist">
        <button id="tabDay" class="active">日</button>
        <button id="tabWeek">週</button>
        <button id="tabMonth">月</button>
      </div>
      <div style="margin-left:auto;display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <button id="prev">上一頁</button>
        <button id="today">今天</button>
        <button id="next">下一頁</button>
        <label class="muted">粒度</label>
        <select id="gran"></select>
        <label class="muted">週起始</label>
        <select id="weekstart">
          <option value="0">周日</option>
          <option value="1">周一</option>
        </select>
        <label class="muted">預設提醒</label>
        <select id="defaultLead">
          <option value="0">不提醒</option>
          <option value="180">3 小時前</option>
          <option value="1440">1 天前</option>
          <option value="custom">自訂</option>
        </select>
        <input id="defaultLeadMin" type="number" min="1" class="muted" style="width:90px" placeholder="分鐘" />
        <button id="exportBtn">匯出</button>
        <label><input id="importFile" type="file" accept="application/json" style="display:none"><button id="importBtn">匯入</button></label>
        <button id="shareBtn">產生分享連結</button>
        <button id="icsBtn">匯出 .ics</button>
        <button id="deleteSelBtn" title="刪除選取 (Del)">刪除選取</button>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="panels">
      <div class="panel">
        <div class="head">分類 / 顏色</div>
        <div class="body">
          <div id="cats"></div>
          <div style="display:flex;gap:8px;margin-top:8px">
            <input id="newCatName" type="text" placeholder="分類名稱（如：工作）" style="flex:1">
            <input id="newCatColor" type="color" value="#8b5cf6">
            <button id="addCat">新增</button>
          </div>
          <div class="legend" id="legend"></div>
          <div class="muted">提示：日/週視圖可拖曳建立行程；選取事件後按 <b>Delete/Backspace</b> 可刪除；禁止與其他事件重疊。</div>
          <div class="muted" style="margin-top:8px">提醒說明：瀏覽器通知僅在頁面開啟時有效；離線提醒請用 .ics 匯出加到系統行事曆。</div>
        </div>
      </div>

      <div class="panel">
        <div id="viewContainer"></div>
      </div>
    </div>
  </div>

  <div class="foot-fab">
    <div class="fab">
      <span class="muted">快速設定：</span>
      <span class="muted">粒度</span>
      <select id="gran2"></select>
      <button id="toTop">回到頂端</button>
      <button id="notifyBtn">啟用通知</button>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <!-- Create/Edit Modal -->
  <div id="modal" class="modal" role="dialog" aria-modal="true" style="display:none;align-items:center;justify-content:center;position:fixed;inset:0;background:rgba(0,0,0,.4);z-index:50">
    <div class="card">
      <h3 id="modalTitle">新增行程</h3>
      <div class="row">
        <label class="muted" style="width:92px">標題</label>
        <input id="mTitle" class="grow" type="text" placeholder="輸入事件名稱">
      </div>
      <div class="row">
        <label class="muted" style="width:92px">分類</label>
        <select id="mCat" class="grow"></select>
      </div>
      <div class="row">
        <label class="muted" style="width:92px">開始 / 結束</label>
        <input id="mStart" class="grow" type="time"><span class="muted">—</span><input id="mEnd" class="grow" type="time">
      </div>
      <div class="row">
        <label class="muted" style="width:92px">提醒</label>
        <select id="mLead" class="grow">
          <option value="0">不提醒</option>
          <option value="180">3 小時前</option>
          <option value="1440">1 天前</option>
          <option value="custom">自訂分鐘</option>
        </select>
        <input id="mLeadMin" type="number" min="1" placeholder="分鐘" style="width:110px;display:none">
      </div>
      <div class="row" style="justify-content:flex-end">
        <button id="mCancel">取消</button>
        <button id="mDelete" style="display:none">刪除</button>
        <button id="mOk">儲存</button>
      </div>
    </div>
  </div>

<script>
(function(){
  // ===== Utilities =====
  const pad2=(n)=> (n<10? "0"+n : ""+n);
  const clamp=(v,min,max)=>Math.max(min,Math.min(max,v));
  const hourH=48; const GRAN=[15,30,60];
  const LS_EVENTS="dragcal.events.v4", LS_CATS="dragcal.categories.v4", LS_SETTINGS="dragcal.settings.v4";
  const el=(id)=>document.getElementById(id);
  const showToast=(msg)=>{ const t=el("toast"); t.textContent=msg; t.classList.add("show"); clearTimeout(t._tid); t._tid=setTimeout(()=>t.classList.remove("show"), 1600); };

  el("tz").textContent = "時區：" + Intl.DateTimeFormat().resolvedOptions().timeZone;

  // ===== State =====
  const state = {
    categories: load(LS_CATS) || [
      { id:"work",  name:"工作", color:"#2563eb" },
      { id:"tutor", name:"家教", color:"#16a34a" },
      { id:"study", name:"學習", color:"#f59e0b" },
      { id:"read",  name:"閱讀", color:"#ec4899" },
    ],
    events: load(LS_EVENTS) || [],
    settings: Object.assign({granularity:60,weekStartsOn:0, defaultLeadMin:0, view:"week"}, load(LS_SETTINGS)||{}),
    anchorDate: null, // represents the current focus date (week uses startOfWeek(anchor), month uses first day)
    selected: null,
    drag: null,
  };
  state.anchorDate = new Date();

  // ===== Helpers =====
  function saveAll(){ save(LS_EVENTS,state.events); save(LS_CATS,state.categories); save(LS_SETTINGS,state.settings); }
  function save(k,v){ localStorage.setItem(k, JSON.stringify(v)); }
  function load(k){ try{ return JSON.parse(localStorage.getItem(k)); }catch(e){ return null; } }
  function startOfWeek(date, w=0){ const d=new Date(date); const day=(d.getDay()-w+7)%7; d.setDate(d.getDate()-day); d.setHours(0,0,0,0); return d; }
  function startOfMonth(date){ const d=new Date(date); d.setDate(1); d.setHours(0,0,0,0); return d; }
  function toKey(d){ return d.toISOString().slice(0,10); }
  function fmtHM(min){ const h=Math.floor(min/60), m=min%60; return pad2(h)+":"+pad2(m); }
  function hmToMin(hm){ const [h,m]=hm.split(":").map(x=>parseInt(x,10)); return h*60+m; }
  function eventsOf(key){ return state.events.filter(e=>e.date===key).sort((a,b)=>a.startMin-b.startMin); }
  function escapeHtml(s){ return (s??"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[m])); }
  function hasConflict(dateKey, s, e, excludeId){
    return state.events.some(ev => ev.date===dateKey && ev.id!==excludeId && Math.max(ev.startMin, s) < Math.min(ev.endMin, e));
  }

  // ===== DOM refs =====
  const tabDay=el("tabDay"), tabWeek=el("tabWeek"), tabMonth=el("tabMonth");
  const prevBtn=el("prev"), todayBtn=el("today"), nextBtn=el("next");
  const gran=el("gran"), gran2=el("gran2"), weekstart=el("weekstart");
  const defaultLead=el("defaultLead"), defaultLeadMin=el("defaultLeadMin");
  const exportBtn=el("exportBtn"), importBtn=el("importBtn"), importFile=el("importFile");
  const shareBtn=el("shareBtn"), icsBtn=el("icsBtn");
  const deleteSelBtn=el("deleteSelBtn");
  const catsWrap=el("cats"), legend=el("legend");
  const toTop=el("toTop"), notifyBtn=el("notifyBtn");
  const viewContainer=el("viewContainer");
  const modal=el("modal"), mTitle=el("mTitle"), mCat=el("mCat"), mStart=el("mStart"), mEnd=el("mEnd"), mLead=el("mLead"), mLeadMin=el("mLeadMin"), mCancel=el("mCancel"), mDelete=el("mDelete"), mOk=el("mOk");
  let modalData=null;

  // Tabs init
  function setView(v){
    state.settings.view=v; saveAll();
    tabDay.classList.toggle("active", v==="day");
    tabWeek.classList.toggle("active", v==="week");
    tabMonth.classList.toggle("active", v==="month");
    renderAll();
  }
  tabDay.onclick=()=>setView("day");
  tabWeek.onclick=()=>setView("week");
  tabMonth.onclick=()=>setView("month");
  setView(state.settings.view||"week");

  // Toolbar init
  ;[gran,gran2].forEach(sel=>{
    sel.innerHTML = GRAN.map(g=>`<option value="${g}">${g} 分</option>`).join("");
    sel.value = String(state.settings.granularity);
    sel.onchange = (e)=>{ state.settings.granularity=parseInt(e.target.value,10); saveAll(); renderAll(); };
  });
  weekstart.value=String(state.settings.weekStartsOn);
  defaultLead.value=(state.settings.defaultLeadMin===180||state.settings.defaultLeadMin===1440||state.settings.defaultLeadMin===0) ? String(state.settings.defaultLeadMin) : "custom";
  defaultLeadMin.style.display = defaultLead.value==="custom" ? "" : "none";
  if(defaultLead.value==="custom") defaultLeadMin.value = state.settings.defaultLeadMin || 10;
  defaultLead.onchange=()=>{
    if(defaultLead.value==="custom"){ defaultLeadMin.style.display=""; state.settings.defaultLeadMin=parseInt(defaultLeadMin.value||"10",10); }
    else{ defaultLeadMin.style.display="none"; state.settings.defaultLeadMin=parseInt(defaultLead.value,10); }
    saveAll();
  };
  defaultLeadMin.oninput=()=>{ if(defaultLead.value==="custom"){ state.settings.defaultLeadMin=parseInt(defaultLeadMin.value||"10",10); saveAll(); } };

  // Prev/Next/Today depending on view
  prevBtn.onclick=()=>{
    if(state.settings.view==="week"){ const d=startOfWeek(state.anchorDate, state.settings.weekStartsOn); d.setDate(d.getDate()-7); state.anchorDate=d; }
    else if(state.settings.view==="day"){ const d=new Date(state.anchorDate); d.setDate(d.getDate()-1); state.anchorDate=d; }
    else { const d=startOfMonth(state.anchorDate); d.setMonth(d.getMonth()-1); state.anchorDate=d; }
    renderAll();
  };
  nextBtn.onclick=()=>{
    if(state.settings.view==="week"){ const d=startOfWeek(state.anchorDate, state.settings.weekStartsOn); d.setDate(d.getDate()+7); state.anchorDate=d; }
    else if(state.settings.view==="day"){ const d=new Date(state.anchorDate); d.setDate(d.getDate()+1); state.anchorDate=d; }
    else { const d=startOfMonth(state.anchorDate); d.setMonth(d.getMonth()+1); state.anchorDate=d; }
    renderAll();
  };
  todayBtn.onclick=()=>{ state.anchorDate=new Date(); renderAll(); };
  weekstart.onchange=(e)=>{ state.settings.weekStartsOn=parseInt(e.target.value,10); saveAll(); renderAll(); };

  // Import/Export/Share/ICS
  exportBtn.onclick=()=>{ const data={events:state.events,categories:state.categories,settings:state.settings}; const blob=new Blob([JSON.stringify(data,null,2)],{type:"application/json"}); const url=URL.createObjectURL(blob); const a=document.createElement("a"); a.href=url; a.download="drag-calendar.json"; a.click(); URL.revokeObjectURL(url); };
  importBtn.onclick=()=>importFile.click();
  importFile.onchange=(e)=>{ const f=e.target.files?.[0]; if(!f) return; const r=new FileReader(); r.onload=(ev)=>{ try{ const data=JSON.parse(ev.target.result); if(data.events&&data.categories&&data.settings){ state.events=data.events; state.categories=data.categories; state.settings=Object.assign(state.settings,data.settings); saveAll(); renderAll(); showToast("匯入完成"); } else showToast("檔案格式不正確"); }catch(err){ showToast("解析失敗"); } }; r.readAsText(f); };
  shareBtn.onclick=()=>{ const data=JSON.stringify({events:state.events,categories:state.categories,settings:state.settings}); const hash="#data="+encodeURIComponent(btoa(data)); const url=(location.origin?location.origin:"")+location.pathname+hash; navigator.clipboard?.writeText(url); showToast("分享連結已複製"); };
  icsBtn.onclick=()=>{ const ics=buildICSForCurrent(); const blob=new Blob([ics],{type:"text/calendar"}); const url=URL.createObjectURL(blob); const a=document.createElement("a"); a.href=url; a.download="calendar.ics"; a.click(); URL.revokeObjectURL(url); };

  // Delete selected
  deleteSelBtn.onclick=deleteSelected;
  document.addEventListener("keydown",(e)=>{
    if(e.key==="Delete"||e.key==="Backspace"){
      if(document.activeElement && ["INPUT","TEXTAREA","SELECT"].includes(document.activeElement.tagName)) return;
      deleteSelected();
    }
  });
  function deleteSelected(){
    if(!state.selected) return;
    state.events = state.events.filter(e=>e.id!==state.selected);
    state.selected=null; saveAll(); renderAll(); showToast("已刪除選取事件");
  }

  // Left panel (cats)
  function renderCats(){
    const catsWrap=el("cats"), legend=el("legend");
    catsWrap.innerHTML="";
    state.categories.forEach(c=>{
      const row=document.createElement("div"); row.className="catrow"; row.style.display="flex"; row.style.gap="8px"; row.style.alignItems="center"; row.style.margin="6px 0";
      row.innerHTML=`<input type="color" value="${c.color}" style="width:40px;height:32px">
        <input type="text" value="${escapeHtml(c.name)}" style="flex:1">
        <button data-act="del">刪除</button>`;
      const [colorEl,nameEl,delBtn]=row.children;
      colorEl.oninput=()=>{ c.color=colorEl.value; saveAll(); renderAll(); };
      nameEl.oninput=()=>{ c.name=nameEl.value; saveAll(); renderAll(); };
      delBtn.onclick=()=>{ state.categories=state.categories.filter(x=>x.id!==c.id); state.events.forEach(ev=>{ if(ev.categoryId===c.id) ev.categoryId=state.categories[0]?.id||null; }); saveAll(); renderAll(); };
      catsWrap.appendChild(row);
    });
    legend.innerHTML="";
    state.categories.forEach(c=>{ const pill=document.createElement("span"); pill.className="pill"; pill.innerHTML=`<span class="dot" style="background:${c.color}"></span><span>${escapeHtml(c.name)}</span>`; legend.appendChild(pill); });
    el("addCat").onclick=()=>{
      const name=el("newCatName").value.trim(); const color=el("newCatColor").value;
      if(!name) return; state.categories.push({id:crypto.randomUUID(), name, color}); el("newCatName").value=""; saveAll(); renderAll();
    };
  }

  // ===== Views =====
  function renderAll(){
    renderCats();
    viewContainer.innerHTML="";
    if(state.settings.view==="week") renderWeek();
    else if(state.settings.view==="day") renderDay();
    else renderMonth();
  }

  // ---- Week View ----
  function renderWeek(){
    const anchor = startOfWeek(state.anchorDate, state.settings.weekStartsOn);
    const days=[]; for(let i=0;i<7;i++){ const d=new Date(anchor); d.setDate(d.getDate()+i); days.push(d); }
    const head=document.createElement("div"); head.className="cal-head";
    head.innerHTML = `<div>時間</div>` + days.map(d=>`<div>${d.toLocaleDateString(undefined,{month:"numeric",day:"numeric"})}<br><span class="muted">${d.toLocaleDateString(undefined,{weekday:"short"})}</span></div>`).join("");
    const bodyWrap=document.createElement("div"); bodyWrap.className="cal-body";
    const grid=document.createElement("div"); grid.className="cal-grid";
    // time col
    const timecol=document.createElement("div"); timecol.className="timecol";
    for(let h=0;h<24;h++){ const r=document.createElement("div"); r.className="timecell"; r.textContent=pad2(h)+":00"; timecol.appendChild(r); }
    grid.appendChild(timecol);
    // day cols
    days.forEach((d,idx)=>{
      const dateKey=toKey(d);
      const col=document.createElement("div"); col.className="daycol"; col.dataset.dateKey=dateKey;
      const perHour=60/state.settings.granularity;
      for(let i=0;i<perHour*24;i++){ const line=document.createElement("div"); line.className="minor"; line.style.top=((i*state.settings.granularity/60)*hourH)+"px"; col.appendChild(line); }
      // events
      for(const ev of eventsOf(dateKey)){
        addEventNode(col, ev);
      }
      col.addEventListener("pointerdown",(e)=>{ if(e.button!==0) return; beginCreate(e,col); });
      grid.appendChild(col);
    });
    bodyWrap.appendChild(grid);
    viewContainer.appendChild(head);
    viewContainer.appendChild(bodyWrap);
  }

  // ---- Day View ----
  function renderDay(){
    const d = new Date(state.anchorDate);
    const head=document.createElement("div"); head.className="day-head";
    head.innerHTML = `<div>時間</div><div>${d.toLocaleDateString(undefined,{year:"numeric",month:"numeric",day:"numeric"})}（${d.toLocaleDateString(undefined,{weekday:"long"})}）</div>`;
    const bodyWrap=document.createElement("div"); bodyWrap.className="day-body";
    const grid=document.createElement("div"); grid.className="day-grid";
    const timecol=document.createElement("div"); timecol.className="timecol";
    for(let h=0;h<24;h++){ const r=document.createElement("div"); r.className="timecell"; r.textContent=pad2(h)+":00"; timecol.appendChild(r); }
    grid.appendChild(timecol);
    const dateKey=toKey(d);
    const col=document.createElement("div"); col.className="daycol-single"; col.dataset.dateKey=dateKey;
    const perHour=60/state.settings.granularity;
    for(let i=0;i<perHour*24;i++){ const line=document.createElement("div"); line.className="minor"; line.style.top=((i*state.settings.granularity/60)*hourH)+"px"; col.appendChild(line); }
    for(const ev of eventsOf(dateKey)){ addEventNode(col, ev); }
    col.addEventListener("pointerdown",(e)=>{ if(e.button!==0) return; beginCreate(e,col); });
    grid.appendChild(col);
    bodyWrap.appendChild(grid);
    viewContainer.appendChild(head);
    viewContainer.appendChild(bodyWrap);
  }

  // ---- Month View ----
  function renderMonth(){
    const first = startOfMonth(state.anchorDate);
    const start = startOfWeek(first, state.settings.weekStartsOn);
    const head=document.createElement("div"); head.className="month-head";
    const wd = [0,1,2,3,4,5,6].map(i=> new Date(2024,7,i+4)); // generate weekdays label
    head.innerHTML = wd.map(d=>`<div>${d.toLocaleDateString(undefined,{weekday:"short"})}</div>`).join("");
    const grid=document.createElement("div"); grid.className="month-grid";
    // 6 weeks * 7 days
    for(let i=0;i<42;i++){
      const d=new Date(start); d.setDate(d.getDate()+i);
      const cell=document.createElement("div"); cell.className="mcell";
      const dateKey=toKey(d);
      const inMonth = d.getMonth()===first.getMonth();
      cell.style.background = inMonth ? "#fff" : "#fafafa";
      cell.innerHTML = `<div class="mdate">${d.getDate()}</div>`;
      const dayEvents = eventsOf(dateKey);
      dayEvents.slice(0,3).forEach(ev=>{
        const cat=state.categories.find(c=>c.id===ev.categoryId);
        const tag=document.createElement("span"); tag.className="mtag";
        tag.style.color = (cat?.color||"#6b7280");
        tag.textContent = `${fmtHM(ev.startMin)} ${ev.title}`;
        tag.title = `${fmtHM(ev.startMin)}–${fmtHM(ev.endMin)} ${ev.title}`;
        cell.appendChild(tag);
      });
      if(dayEvents.length>3){
        const more=document.createElement("span"); more.className="mtag"; more.style.color="#6b7280"; more.textContent = `+${dayEvents.length-3} 更多…`;
        cell.appendChild(more);
      }
      cell.addEventListener("click",()=>{ state.anchorDate=d; setView("day"); });
      grid.appendChild(cell);
    }
    viewContainer.appendChild(head);
    viewContainer.appendChild(grid);
  }

  // ---- Event node helper ----
  function addEventNode(col, ev){
    const cat=state.categories.find(c=>c.id===ev.categoryId);
    const top=(ev.startMin/60)*hourH, h=Math.max(10,((ev.endMin-ev.startMin)/60)*hourH);
    const node=document.createElement("div"); node.className="event"+(state.selected===ev.id?" sel":"");
    node.style.top=top+"px"; node.style.height=h+"px"; node.style.borderColor=(cat?.color||"#94a3b8"); node.style.background=(cat?.color||"#94a3b8")+"22"; node.dataset.id=ev.id;
    node.innerHTML=`<div class="handle top"></div><div class="handle bot"></div>
      <div class="pad">
        <div style="display:flex;align-items:center;gap:6px">
          <span class="dot" style="background:${cat?.color||"#94a3b8"}"></span>
          <input class="title" value="${escapeHtml(ev.title)}">
        </div>
        <div class="meta">${fmtHM(ev.startMin)}–${fmtHM(ev.endMin)}${ev.leadMin?` ・ 提前 ${ev.leadMin} 分提醒`:``}</div>
        <div class="bar">
          <select class="catSel">
            ${state.categories.map(c=>`<option value="${c.id}" ${ev.categoryId===c.id?"selected":""}>${escapeHtml(c.name)}</option>`).join("")}
          </select>
          <select class="leadSel">
            <option value="0" ${!ev.leadMin||ev.leadMin===0?"selected":""}>不提醒</option>
            <option value="180" ${ev.leadMin===180?"selected":""}>3小時前</option>
            <option value="1440" ${ev.leadMin===1440?"selected":""}>1天前</option>
            <option value="custom" ${ev.leadMin && ![0,180,1440].includes(ev.leadMin)?"selected":""}>自訂</option>
          </select>
          <input class="leadMin" type="number" min="1" placeholder="分鐘" style="width:90px; ${ev.leadMin && ![0,180,1440].includes(ev.leadMin)?'':'display:none'}" value="${ev.leadMin && ![0,180,1440].includes(ev.leadMin)?ev.leadMin:''}">
        </div>
      </div>`;
    node.addEventListener("pointerdown",(e)=>{
      if(e.target.classList.contains("handle") || e.target.classList.contains("title") || e.target.classList.contains("leadSel") || e.target.classList.contains("leadMin") || e.target.classList.contains("catSel")) return;
      e.stopPropagation(); state.selected=ev.id; renderAll();
    });
    node.querySelector(".handle.top").addEventListener("pointerdown",(e)=>{ e.stopPropagation(); beginDrag(e,"resize-top",ev,col); });
    node.querySelector(".handle.bot").addEventListener("pointerdown",(e)=>{ e.stopPropagation(); beginDrag(e,"resize-bottom",ev,col); });
    node.querySelector(".title").addEventListener("input",(e)=>{ ev.title=e.target.value; saveAll(); });
    node.querySelector(".catSel").addEventListener("change",(e)=>{ ev.categoryId=e.target.value; saveAll(); renderAll(); });
    const leadSel=node.querySelector(".leadSel"), leadMin=node.querySelector(".leadMin");
    leadSel.addEventListener("change",(e)=>{
      if(e.target.value==="custom"){ leadMin.style.display=""; leadMin.focus(); }
      else{ ev.leadMin=parseInt(e.target.value,10); leadMin.style.display="none"; leadMin.value=""; saveAll(); }
    });
    leadMin.addEventListener("input",(e)=>{ const v=parseInt(e.target.value||"10",10); ev.leadMin=v; saveAll(); });
    col.appendChild(node);
  }

  // ---- Create/Drag (day&week) ----
  function yToMin(col, yClient){
    const rect=col.getBoundingClientRect(); const y=clamp(yClient-rect.top,0,rect.height);
    const snap=Math.round((y/hourH)*60/state.settings.granularity)*state.settings.granularity;
    return clamp(snap,0,24*60);
  }
  function beginCreate(e,col){
    col.setPointerCapture(e.pointerId);
    const dateKey=col.dataset.dateKey;
    const s=yToMin(col,e.clientY);
    state.drag={mode:"create", dateKey, startMin:s, col};
    window.addEventListener("pointerup", onUpCreate, {passive:false});
  }
  function onUpCreate(e){
    window.removeEventListener("pointerup", onUpCreate);
    const d=state.drag; state.drag=null; if(!d) return;
    const endMin=yToMin(d.col,e.clientY);
    const s=Math.min(d.startMin,endMin), t=Math.max(d.startMin,endMin);
    const minDur=state.settings.granularity;
    const start=s===t ? s : s, end=s===t ? s+minDur : t;
    if(hasConflict(d.dateKey, start, end)){ showToast("此時段已有行程，無法新增"); return; }
    openModal("create",{dateKey:d.dateKey,startMin:start,endMin:end});
  }
  function beginDrag(e,mode,ev,col){
    col.setPointerCapture(e.pointerId);
    state.drag={mode, ev:{...ev}, id:ev.id, startY:e.clientY, col};
    window.addEventListener("pointermove", onMove, {passive:false});
    window.addEventListener("pointerup", onUp, {passive:false});
  }
  function onMove(e){
    if(!state.drag) return; e.preventDefault();
    const d=state.drag; const cur=yToMin(d.col,e.clientY);
    const ev = state.events.find(x=>x.id===d.id); if(!ev) return;
    if(d.mode==="resize-top"){
      const ns=clamp(cur,0,ev.endMin - state.settings.granularity);
      if(!hasConflict(ev.date, ns, ev.endMin, ev.id)){ ev.startMin=ns; saveAll(); renderAll(); }
    }else if(d.mode==="resize-bottom"){
      const ne=clamp(cur, ev.startMin + state.settings.granularity, 24*60);
      if(!hasConflict(ev.date, ev.startMin, ne, ev.id)){ ev.endMin=ne; saveAll(); renderAll(); }
    }else if(d.mode==="move"){
      const delta = cur - yToMin(d.col, d.startY);
      const dur = d.ev.endMin - d.ev.startMin;
      let ns = clamp(d.ev.startMin + delta, 0, 24*60 - dur);
      let ne = ns + dur;
      if(!hasConflict(ev.date, ns, ne, ev.id)){ ev.startMin=ns; ev.endMin=ne; saveAll(); renderAll(); }
    }
  }
  function onUp(){ window.removeEventListener("pointermove", onMove); window.removeEventListener("pointerup", onUp); state.drag=null; }

  // ---- Modal ----
  function openModal(mode,payload){
    modalData={mode, ...payload};
    el("modal").style.display="flex";
    el("modalTitle").textContent = mode==="create" ? "新增行程" : "編輯行程";
    mCat.innerHTML = state.categories.map(c=>`<option value="${c.id}">${escapeHtml(c.name)}</option>`).join("");
    mTitle.value = payload.title || "";
    mCat.value = payload.categoryId || state.categories[0]?.id || "";
    mStart.value = fmtHM(payload.startMin);
    mEnd.value = fmtHM(payload.endMin);
    const lead = payload.leadMin; const isStd = (lead===0||lead===180||lead===1440||lead==null);
    mLead.value = isStd ? String(lead||0) : "custom";
    mLeadMin.style.display = mLead.value==="custom" ? "" : "none";
    if(mLead.value==="custom") mLeadMin.value = lead || state.settings.defaultLeadMin || 10;
    mDelete.style.display = mode==="edit" ? "" : "none";
  }
  function closeModal(){ el("modal").style.display="none"; modalData=null; }
  el("modal").addEventListener("click",(e)=>{ if(e.target===el("modal")) closeModal(); });
  mCancel.onclick=closeModal;
  mLead.onchange=()=>{ mLeadMin.style.display = mLead.value==="custom" ? "" : "none"; if(mLead.value==="custom" && !mLeadMin.value) mLeadMin.value = state.settings.defaultLeadMin || 10; };
  mDelete.onclick=()=>{
    if(modalData?.mode!=="edit") return;
    state.events = state.events.filter(e=>e.id!==modalData.id);
    saveAll(); closeModal(); renderAll();
  };
  mOk.onclick=()=>{
    if(!modalData) return;
    const title=(mTitle.value.trim()||"新行程");
    const categoryId=mCat.value || state.categories[0]?.id || null;
    const s=hmToMin(mStart.value), e=hmToMin(mEnd.value);
    let leadMin=0; if(mLead.value==="custom") leadMin=parseInt(mLeadMin.value||"10",10); else leadMin=parseInt(mLead.value,10);
    if(s>=e){ showToast("結束時間需大於開始時間"); return; }
    if(modalData.mode==="create"){
      if(hasConflict(modalData.dateKey, s, e)){ showToast("此時段已有行程，無法新增"); return; }
      const id=crypto.randomUUID(); state.events.push({id,date:modalData.dateKey,startMin:s,endMin:e,title,categoryId,leadMin}); state.selected=id;
    }else{
      const ev=state.events.find(x=>x.id===modalData.id);
      if(!ev) return;
      if(hasConflict(ev.date, s, e, ev.id)){ showToast("與其他行程重疊，無法儲存"); return; }
      Object.assign(ev,{title,categoryId,startMin:s,endMin:e,leadMin});
    }
    saveAll(); closeModal(); renderAll();
  };

  // ---- Notifications (page-open only) ----
  notifyBtn.onclick=async()=>{
    if(!("Notification" in window)) return showToast("瀏覽器不支援通知");
    const p=await Notification.requestPermission();
    if(p!=="granted") showToast("未授權通知");
    else { if("serviceWorker" in navigator){ try{ await navigator.serviceWorker.register("./sw.js"); }catch(e){} } showToast("通知已啟用"); }
  };
  let notified=new Set();
  function ticker(){
    const now=new Date();
    for(const ev of state.events){
      if(!ev.leadMin||ev.leadMin<=0) continue;
      const [y,m,d]=ev.date.split("-").map(Number);
      const start=new Date(y,m-1,d, Math.floor(ev.startMin/60), ev.startMin%60, 0);
      const remind=new Date(start.getTime()-ev.leadMin*60000);
      if(remind<=now && start>now){
        const k=ev.id+"@"+remind.toISOString();
        if(!notified.has(k)){
          notified.add(k);
          if("Notification" in window && Notification.permission==="granted"){
            new Notification("提醒："+ev.title, { body: `${ev.date} ${fmtHM(ev.startMin)} 開始（提前 ${ev.leadMin} 分）` });
          }else alert(`提醒：${ev.title}\n${ev.date} ${fmtHM(ev.startMin)} 開始（提前 ${ev.leadMin} 分）`);
        }
      }
    }
    if(notified.size>1000) notified=new Set([...notified].slice(-500));
  }
  setInterval(ticker, 30000); ticker();

  // ---- ICS builder ----
  function dtstamp(){ const d=new Date(); return d.toISOString().replace(/[-:]/g,"").split(".")[0]+"Z"; }
  function toICSDate(dateKey, min){ const [y,m,da]=dateKey.split("-").map(Number); const h=Math.floor(min/60), mi=min%60; const dt=new Date(Date.UTC(y,m-1,da,h,mi,0)); return dt.toISOString().replace(/[-:]/g,"").split(".")[0]+"Z"; }
  function buildICSForCurrent(){
    let keys=[];
    if(state.settings.view==="day"){
      keys=[toKey(new Date(state.anchorDate))];
    }else if(state.settings.view==="week"){
      const w=startOfWeek(state.anchorDate, state.settings.weekStartsOn);
      for(let i=0;i<7;i++){ const d=new Date(w); d.setDate(d.getDate()+i); keys.push(toKey(d)); }
    }else{
      const first=startOfMonth(state.anchorDate);
      const last=new Date(first); last.setMonth(last.getMonth()+1); last.setDate(0);
      for(let d=new Date(first); d<=last; d.setDate(d.getDate()+1)){ keys.push(toKey(d)); }
    }
    const items=state.events.filter(e=>keys.includes(e.date));
    let out="BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-/DragCal/EN\nCALSCALE:GREGORIAN\nMETHOD:PUBLISH\n";
    const stamp=dtstamp();
    for(const ev of items){
      const uid=ev.id+"@dragcal";
      out+="BEGIN:VEVENT\nDTSTAMP:"+stamp+"\nUID:"+uid+"\nSUMMARY:"+ev.title.replace(/([,;])/g,"\\$1")+"\nDTSTART:"+toICSDate(ev.date,ev.startMin)+"\nDTEND:"+toICSDate(ev.date,ev.endMin)+"\n";
      if(ev.leadMin&&ev.leadMin>0){ out+="BEGIN:VALARM\nTRIGGER:-PT"+ev.leadMin+"M\nACTION:DISPLAY\nDESCRIPTION:"+ev.title.replace(/([,;])/g,"\\$1")+"\nEND:VALARM\n"; }
      out+="END:VEVENT\n";
    }
    out+="END:VCALENDAR\n";
    return out;
  }

  // ---- Init render ----
  renderAll();
  toTop.onclick=()=>window.scrollTo({top:0,behavior:"smooth"});

  // Load from share link if present
  try{
    const hash = location.hash.startsWith("#data=") ? location.hash.slice(6) : null;
    if(hash){
      const json = atob(decodeURIComponent(hash));
      const data = JSON.parse(json);
      if(data.events && data.categories && data.settings){
        state.events = data.events;
        state.categories = data.categories;
        state.settings = Object.assign(state.settings, data.settings);
        history.replaceState(null,"",location.pathname);
        renderAll();
      }
    }
  }catch(err){ console.warn("share import failed", err); }

})();</script>

<script>
if('serviceWorker' in navigator){ navigator.serviceWorker.register('./sw.js').catch(()=>{}); }
</script>
</body>
</html>
